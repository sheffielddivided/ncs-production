<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
  <title>NCS Production</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
  <style>
    :root {
      --bg:#f1f1f1; --card:#fff;
      --navy:#7d2248;        /* mørk magenta - topbar, primær UI */
      --blue:#ce0f69;        /* magenta - aktive elementer */
      --border:#d5d5d5;      /* grå 20% */
      --muted:#828282;       /* grå 60% */
      --light:#f5cfe1;       /* magenta 20% - bakgrunnsflater */
      --green:#00b373;       /* sekundær grønn - download */
    }
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
    html,body{height:100%;}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:#1a2332;overscroll-behavior:none;}

    /* TOP BAR */
    .topbar{background:var(--navy);color:#fff;padding:14px 16px 10px;display:flex;align-items:center;justify-content:space-between;gap:10px;position:sticky;top:0;z-index:50;}
    .topbar-title{font-size:1rem;font-weight:700;letter-spacing:-0.01em;}
    .topbar-sub{font-size:0.7rem;opacity:0.65;margin-top:1px;}
    .mode-switcher{display:flex;background:var(--light);border-radius:8px;padding:3px;gap:2px;}
    .mode-btn{padding:6px 14px;border:none;border-radius:6px;font-size:0.8rem;font-weight:700;cursor:pointer;background:none;color:var(--muted);transition:all 0.15s;letter-spacing:0.01em;}
    .mode-btn.active{background:var(--blue);color:#fff;}

    /* CONTROLS BAR */
    .controls-bar{background:var(--card);border-bottom:1px solid var(--border);padding:10px 12px;display:flex;flex-direction:column;gap:8px;}
    .ctrl-row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
    .year-row{display:flex;gap:6px;align-items:center;}
    .year-row label{font-size:0.7rem;font-weight:600;color:var(--muted);text-transform:uppercase;}
    .year-select{padding:6px 24px 6px 8px;border:1.5px solid var(--border);border-radius:7px;font-size:0.82rem;color:#1a2332;background:#fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24'%3E%3Cpath fill='%234a5568' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E") no-repeat right 6px center;appearance:none;-webkit-appearance:none;cursor:pointer;}
    .pill-group{display:flex;border:1.5px solid var(--border);border-radius:7px;overflow:hidden;}
    .pill-btn{padding:6px 11px;border:none;background:#fff;font-size:0.75rem;font-weight:500;color:var(--muted);cursor:pointer;white-space:nowrap;}
    .pill-btn:not(:last-child){border-right:1.5px solid var(--border);}
    .pill-btn.active{background:var(--blue);color:#fff;}
    .ctrl-label{font-size:0.7rem;font-weight:600;color:var(--muted);text-transform:uppercase;white-space:nowrap;}

    /* VIEW SUB-TABS */
    .view-tabs{display:flex;gap:6px;flex-wrap:wrap;}
    .view-tab{padding:5px 10px;border:1.5px solid var(--border);border-radius:20px;font-size:0.72rem;font-weight:600;color:var(--muted);background:#fff;cursor:pointer;white-space:nowrap;}
    .view-tab.active{background:var(--blue);color:#fff;border-color:var(--blue);}

    /* WATER TOGGLE */
    .water-row{display:flex;align-items:center;gap:8px;}
    .toggle-switch{position:relative;width:36px;height:20px;flex-shrink:0;}
    .toggle-switch input{opacity:0;width:0;height:0;}
    .toggle-slider{position:absolute;inset:0;background:#ccc;border-radius:20px;cursor:pointer;transition:0.2s;}
    .toggle-slider:before{content:'';position:absolute;width:14px;height:14px;left:3px;top:3px;background:#fff;border-radius:50%;transition:0.2s;}
    input:checked+.toggle-slider{background:var(--blue);}
    input:checked+.toggle-slider:before{transform:translateX(16px);}
    .water-label{font-size:0.72rem;color:var(--muted);}

    /* SELECT FAB */
    .select-fab{position:fixed;bottom:24px;right:16px;z-index:40;background:var(--blue);color:#fff;border:none;border-radius:28px;padding:13px 20px;font-size:0.88rem;font-weight:600;box-shadow:0 4px 16px rgba(0,48,87,0.35);cursor:pointer;display:flex;align-items:center;gap:8px;transition:transform 0.15s;}
    .select-fab:active{transform:scale(0.96);}
    .fab-badge{background:#e36b2f;color:#fff;border-radius:10px;font-size:0.72rem;font-weight:700;padding:1px 7px;min-width:20px;text-align:center;}

    /* CHART */
    .chart-wrap{padding:12px 12px 4px;}
    .chart-card{background:var(--card);border-radius:12px;box-shadow:0 1px 8px rgba(0,0,0,0.06);padding:12px 10px 10px;}
    .chart-title{font-size:0.85rem;font-weight:700;color:var(--navy);padding:2px 2px 8px;line-height:1.3;min-height:1.2em;}
    .chart-title .ct-sub{font-weight:400;color:var(--muted);font-size:0.78rem;display:block;margin-top:2px;}
    .chart-container{position:relative;height:300px;}
    .status{text-align:center;padding:60px 20px;color:var(--muted);font-size:0.9rem;}
    .status .spinner{display:inline-block;width:30px;height:30px;border:3px solid #e2e8f0;border-top-color:var(--blue);border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:10px;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .legend-row{display:flex;gap:8px 14px;flex-wrap:wrap;margin-top:10px;padding-top:10px;border-top:1px solid var(--border);}
    .legend-item{display:flex;align-items:center;gap:6px;font-size:0.72rem;color:var(--muted);}
    .legend-dot{width:9px;height:9px;border-radius:2px;flex-shrink:0;}

    /* INFO BOX */
    .info-box{margin:0 12px 8px;background:var(--light);border:1px solid #eeabcb;border-radius:8px;padding:10px 12px;font-size:0.72rem;color:#2f2f2f;line-height:1.5;}
    .info-box strong{color:#1a2332;}

    /* DOWNLOAD */
    .dl-row{padding:0 12px 8px;display:flex;justify-content:flex-end;}
    .dl-btn{display:flex;align-items:center;gap:6px;padding:8px 14px;border:1.5px solid var(--green);border-radius:8px;background:#fff;font-size:0.8rem;font-weight:500;color:var(--green);cursor:pointer;}
    .dl-btn:disabled{opacity:0.4;pointer-events:none;}
    .dl-btn svg{width:13px;height:13px;}
    .source-note{padding:6px 12px 80px;font-size:0.68rem;color:#a0aab8;text-align:right;}
    .source-note a{color:var(--blue);text-decoration:none;}

    /* BOTTOM SHEET */
    .sheet-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:60;opacity:0;pointer-events:none;transition:opacity 0.25s;}
    .sheet-overlay.open{opacity:1;pointer-events:all;}
    .bottom-sheet{position:fixed;left:0;right:0;bottom:0;background:var(--card);border-radius:18px 18px 0 0;z-index:70;display:flex;flex-direction:column;transform:translateY(100%);transition:transform 0.3s cubic-bezier(0.32,0.72,0,1);max-height:82vh;}
    .bottom-sheet.open{transform:translateY(0);}
    .sheet-handle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:12px auto 0;flex-shrink:0;}
    .sheet-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px 8px;flex-shrink:0;border-bottom:1px solid var(--border);}
    .sheet-header h3{font-size:1rem;font-weight:700;color:var(--blue);}
    .sheet-close{width:30px;height:30px;border-radius:50%;border:none;background:var(--light);color:var(--muted);font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .sheet-search{margin:10px 16px 0;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:0.9rem;color:#1a2332;outline:none;flex-shrink:0;}
    .sheet-search:focus{border-color:var(--blue);}
    .sheet-search:disabled{background:var(--light);color:#a0aab8;}
    .sheet-actions{display:flex;gap:8px;padding:8px 16px;flex-shrink:0;}
    .sheet-action-btn{flex:1;padding:7px 0;border:1.5px solid var(--border);border-radius:6px;background:#fff;font-size:0.78rem;color:var(--muted);cursor:pointer;}
    .sheet-list{overflow-y:auto;flex:1;-webkit-overflow-scrolling:touch;}
    .check-item{display:flex;align-items:center;gap:10px;padding:12px 16px;border-bottom:1px solid #f0f3f7;font-size:0.9rem;cursor:pointer;user-select:none;}
    .check-item:last-child{border-bottom:none;}
    .check-item.checked{background:var(--light);font-weight:500;color:var(--navy);}
    .check-item input[type=checkbox]{accent-color:var(--blue);width:17px;height:17px;flex-shrink:0;}
    .list-empty{padding:20px;color:#a0aab8;font-size:0.85rem;text-align:center;}
    .list-loading{padding:20px;color:#a0aab8;font-size:0.85rem;text-align:center;}
    .cmp-loading-notice{padding:0 16px 8px;font-size:0.75rem;color:var(--muted);display:none;flex-shrink:0;}
    .cmp-loading-notice.visible{display:block;}
    .sheet-bottom-pad{height:env(safe-area-inset-bottom,12px);flex-shrink:0;}
  </style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <div>
    <div class="topbar-title">NCS Production</div>
    <div class="topbar-sub">Norwegian Continental Shelf · Sodir FactPages</div>
  </div>
</div>

<!-- CONTROLS BAR -->
<div class="controls-bar">
  <!-- Row 0: Mode -->
  <div class="ctrl-row">
    <div class="mode-switcher">
      <button class="mode-btn" id="modeBtnFields" onclick="switchMode('fields')">Fields</button>
      <button class="mode-btn active" id="modeBtnCompanies" onclick="switchMode('companies')">Companies</button>
    </div>
  </div>
  <!-- Row 1: Years + Period -->
  <div class="ctrl-row">
    <div class="year-row">
      <label>From</label>
      <select class="year-select" id="yearFrom"></select>
      <label>To</label>
      <select class="year-select" id="yearTo"></select>
    </div>
    <div class="pill-group">
      <button class="pill-btn active" id="btnMonthly" onclick="setPeriod('monthly')">Monthly</button>
      <button class="pill-btn" id="btnAnnual" onclick="setPeriod('annual')">Annual</button>
    </div>
  </div>

  <!-- Row 2: View sub-tabs (dynamic) -->
  <div class="ctrl-row">
    <span class="ctrl-label">Show</span>
    <div class="view-tabs" id="viewTabs"></div>
  </div>

  <!-- Row 3: Water toggle (fields oil/gas only) -->
  <div class="ctrl-row" id="waterRow" style="display:none">
    <div class="water-row">
      <label class="toggle-switch">
        <input type="checkbox" id="waterToggle" onchange="setWater(this.checked)"/>
        <span class="toggle-slider"></span>
      </label>
      <span class="water-label">Show produced water</span>
    </div>
  </div>
</div>

<!-- CHART -->
<div class="chart-wrap">
  <div class="chart-card">
    <div id="chartTitle" class="chart-title"></div>
    <div id="chartArea">
      <div class="status"><div class="spinner"></div><div>Loading…</div></div>
    </div>
  </div>
</div>

<!-- INFO BOX -->
<div class="info-box" id="infoBox"></div>

<!-- DOWNLOAD -->
<div class="dl-row">
  <button class="dl-btn" id="downloadBtn" onclick="downloadExcel()" disabled>
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
      <polyline points="7 10 12 15 17 10"/>
      <line x1="12" y1="15" x2="12" y2="3"/>
    </svg>
    Download Excel
  </button>
</div>

<div class="source-note"><a href="https://factpages.sodir.no" target="_blank">Norwegian Offshore Directorate</a> – NLOD 2.0</div>

<!-- FAB -->
<button class="select-fab" id="selectFab" onclick="toggleSheet()">
  <span id="fabLabel">Select</span>
  <span class="fab-badge" id="fabBadge">0</span>
</button>

<!-- OVERLAY + SHEET -->
<div class="sheet-overlay" id="sheetOverlay" onclick="closeSheet()"></div>
<div class="bottom-sheet" id="bottomSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <h3 id="sheetTitle">Select</h3>
    <button class="sheet-close" onclick="closeSheet()">&#10005;</button>
  </div>
  <input class="sheet-search" id="listSearch" type="text" placeholder="Search…" oninput="filterList()" disabled/>
  <div class="sheet-actions">
    <button class="sheet-action-btn" onclick="selectAll()">Select all</button>
    <button class="sheet-action-btn" onclick="clearAll()">Clear all</button>
  </div>
  <div class="cmp-loading-notice" id="cmpLoadingNotice">Loading ownership data…</div>
  <div class="sheet-list" id="checkList"><div class="list-loading">Loading…</div></div>
  <div class="sheet-bottom-pad"></div>
</div>

<script>
// ── CONSTANTS ────────────────────────────────────────────────────────────────
const BASE        = 'https://factmaps.sodir.no/api/rest/services/DataService/Data/FeatureServer';
const FIELD_LAYER = 7100;
const PROD_LAYER  = 7300;
const LIC_LAYER   = 7108;
const RES_LAYER   = 7114; // Field - Reserves - company
const BBL_PER_SM3 = 6.29;

// Aker BP brand palette: magenta primary, orange+green secondary, support colors
const PALETTE = [
  ['rgba(206,15,105,0.85)', 'rgba(206,15,105,0.45)'],  // magenta
  ['rgba(246,141,46,0.85)', 'rgba(246,141,46,0.45)'],  // oransje
  ['rgba(0,179,115,0.85)',  'rgba(0,179,115,0.45)'],   // grønn
  ['rgba(73,147,180,0.85)', 'rgba(73,147,180,0.45)'],  // blå støtte
  ['rgba(209,79,78,0.85)',  'rgba(209,79,78,0.45)'],   // rød støtte
  ['rgba(232,201,66,0.85)', 'rgba(232,201,66,0.45)'],  // gul støtte
  ['rgba(125,34,72,0.85)',  'rgba(125,34,72,0.45)'],   // mørk magenta
  ['rgba(213,51,128,0.85)', 'rgba(213,51,128,0.45)'],  // magenta 85%
  ['rgba(221,87,150,0.85)', 'rgba(221,87,150,0.45)'],  // magenta 70%
  ['rgba(231,135,180,0.85)','rgba(231,135,180,0.45)'], // magenta 50%
];
const OIL_COLOR   = 'rgba(206,15,105,0.85)';   // magenta
const GAS_COLOR   = 'rgba(246,141,46,0.75)';   // oransje
const WATER_COLOR = 'rgba(73,147,180,0.75)';   // blå støtte

// ── STATE ────────────────────────────────────────────────────────────────────
let topMode    = 'companies'; // 'fields' | 'companies'
let period     = 'monthly';
let showWater  = false;

// subView per topMode:
//   fields:    'oilgas' | 'oe_per_field' | 'oe_per_company'
//   companies: 'oilgas' | 'oe_per_field'
let fieldSubView   = 'oilgas';
let companySubView = 'oilgas';

// Selection
let allFields            = [];
let filteredFields       = [];
let selectedFieldIds     = new Set();

let allCompanies         = [];
let filteredCompanies    = [];
let selectedCompanyNames = new Set();

// Caches
let fieldProdCache  = {}; // id → features[]
let companyReserves = {}; // cmpLongName → total OE reserves (mill Sm3)
let reservesLoaded  = false;
let fieldLicCache   = {}; // id → licensee records[]
let licLoadedFor    = new Set();
let allLicRecords   = [];
let allLicLoaded    = false;
let allLicLoading   = false;

let chartInstance   = null;
let lastLabels      = [];
let lastDatasets    = []; // [{label, data}] for Excel
let sheetOpen       = false;

// ── YEAR SELECTORS ───────────────────────────────────────────────────────────
const currentYear = new Date().getFullYear();
['yearFrom','yearTo'].forEach(id => {
  const sel = document.getElementById(id);
  for (let y = 1970; y <= currentYear; y++) sel.appendChild(new Option(y, y));
  sel.addEventListener('change', () => {
    sessionClearProd();   // clear session storage for prod data
    fieldProdCache = {};  // reset in-memory cache
    refresh();
  });
});
document.getElementById('yearFrom').value = 2024;
document.getElementById('yearTo').value   = currentYear;

// ── HELPERS ──────────────────────────────────────────────────────────────────
const daysInMonth = (y,m) => new Date(y,m,0).getDate();
const daysInYear  = y => (y%4===0&&(y%100!==0||y%400===0))?366:365;

// ── SESSION STORAGE CACHE ────────────────────────────────────────────────────
const SESSION_PREFIX = 'ncs_prod_v1_';
function sessionGet(key) {
  try { const v = sessionStorage.getItem(SESSION_PREFIX+key); return v ? JSON.parse(v) : null; }
  catch(e) { return null; }
}
function sessionSet(key, val) {
  try { sessionStorage.setItem(SESSION_PREFIX+key, JSON.stringify(val)); } catch(e) {}
}
function sessionClearProd() {
  try {
    Object.keys(sessionStorage)
      .filter(k => k.startsWith(SESSION_PREFIX+'prod_'))
      .forEach(k => sessionStorage.removeItem(k));
  } catch(e) {}
}

async function queryLayer(layerId, params) {
  const url = new URL(`${BASE}/${layerId}/query`);
  const p = {f:'json',outFields:'*',where:'1=1',resultRecordCount:2000,...params};
  Object.entries(p).forEach(([k,v]) => url.searchParams.set(k,v));
  const res = await fetch(url);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const data = await res.json();
  if (data.error) throw new Error(data.error.message);
  return data.features || [];
}

function midDate(year, month) {
  return period === 'monthly' ? new Date(year, month-1, 15) : new Date(year, 6, 1);
}
function periodKey(a) {
  return period === 'monthly'
    ? `${a.prfYear}-${String(a.prfMonth).padStart(2,'0')}`
    : `${a.prfYear}`;
}
function isValidRow(a) {
  return period === 'monthly' ? a.prfMonth > 0 : a.prfMonth === 0;
}
function days(a) {
  return period === 'monthly' ? daysInMonth(a.prfYear, a.prfMonth) : daysInYear(a.prfYear);
}
function oeBoed(oeMillSm3, d) { return (oeMillSm3 * 1e6 * BBL_PER_SM3) / d; }
function oilBoed(oilMillSm3, gasBillSm3, oeMillSm3, d) {
  const gasBoe  = (gasBillSm3 * 1e6 * BBL_PER_SM3) / d;
  const totBoe  = oeBoed(oeMillSm3, d);
  return Math.max(0, totBoe - gasBoe);
}
function gasBoed(gasBillSm3, d) { return (gasBillSm3 * 1e6 * BBL_PER_SM3) / d; }
function waterBoed(watMillSm3, d) { return (watMillSm3 * 1e6 * BBL_PER_SM3) / d; }

// Hardcoded ownership for trial production fields not in licensee registry
const TRIAL_PROD_OWNERSHIP = {
  17196400: { // 16/1-12 TROLDHAUGEN - PL338C
    'Aker BP ASA':    80.0,
    'OMV (Norge) AS': 20.0,
  },
};

function getFieldsForCompany(cmpName) {
  const fromLic = [...new Set(allLicRecords.filter(r=>r.cmpLongName===cmpName).map(r=>r.fldNpdidField))];
  const fromTrial = Object.entries(TRIAL_PROD_OWNERSHIP)
    .filter(([,owners]) => (owners[cmpName]||0) > 0)
    .map(([id]) => +id);
  return [...new Set([...fromLic, ...fromTrial])];
}

function getShare(fieldId, date, companyName) {
  if (!companyName) return 100;
  // Check hardcoded trial production ownership first
  if (TRIAL_PROD_OWNERSHIP[fieldId]) {
    return TRIAL_PROD_OWNERSHIP[fieldId][companyName] ?? 0;
  }
  const records = fieldLicCache[fieldId] || [];
  const ts = date.getTime();
  const match = records.find(r => {
    if (r.cmpLongName !== companyName) return false;
    if (r.fldLicenseeFrom !== null && ts < r.fldLicenseeFrom) return false;
    if (r.fldLicenseeTo   !== null && ts > r.fldLicenseeTo)   return false;
    return true;
  });
  return match ? (match.fldCompanyShare || 0) : 0;
}

function hasAnyValue(arr) { return arr.some(v => v > 0); }

function unionLabels(fieldIds) {
  const s = new Set();
  fieldIds.forEach(id => {
    (fieldProdCache[id] || []).forEach((f) => {
      if (isValidRow(f.attributes)) s.add(periodKey(f.attributes));
    });
  });
  return [...s].sort();
}

// ── DATA LOADING ─────────────────────────────────────────────────────────────
async function loadFields() {
  const features = await queryLayer(FIELD_LAYER, {
    outFields:'fldNpdidField,fldName', orderByFields:'fldName ASC', resultRecordCount:500
  });
  allFields = features
    .map(f => ({id:f.attributes.fldNpdidField, name:f.attributes.fldName}))
    .sort((a,b) => a.name.localeCompare(b.name,'en'));

  // Hardcoded exceptions: fields in trial production not yet in the field registry
  const TRIAL_PROD_FIELDS = [
    { id: 17196400, name: '16/1-12 TROLDHAUGEN', trialProd: true },
  ];
  TRIAL_PROD_FIELDS.forEach(tp => {
    if (!allFields.find(f => f.id === tp.id)) allFields.push(tp);
  });

  filteredFields = allFields;
  // Default: JOHAN SVERDRUP
  const js = allFields.find(f => f.name === 'JOHAN SVERDRUP');
  if (js) selectedFieldIds.add(js.id);
  document.getElementById('listSearch').disabled = false;
}

async function loadProdForFields(ids) {
  const fy = +document.getElementById('yearFrom').value;
  const ty = +document.getElementById('yearTo').value;
  // Check session cache first
  ids.forEach(id => {
    if (fieldProdCache[id] === undefined) {
      const cached = sessionGet(`prod_${id}_${fy}_${ty}`);
      if (cached) fieldProdCache[id] = cached;
    }
  });
  const toFetch = ids.filter(id => fieldProdCache[id] === undefined || fieldProdCache[id] === null);
  if (!toFetch.length) return;
  const BATCH = 10;
  for (let i = 0; i < toFetch.length; i += BATCH) {
    const batch = toFetch.slice(i, i + BATCH);
    await Promise.all(batch.map(async id => {
      try {
        const rows = await queryLayer(PROD_LAYER, {
          where: `prfNpdidInformationCarrier=${id} AND prfYear>=${fy} AND prfYear<=${ty}`,
          outFields: 'prfNpdidInformationCarrier,prfYear,prfMonth,prfPrdOilNetMillSm3,prfPrdGasNetBillSm3,prfPrdOeNetMillSm3,prfPrdProducedWaterInFieldMillS',
          resultRecordCount: 32000
        });
        fieldProdCache[id] = rows;
        sessionSet(`prod_${id}_${fy}_${ty}`, rows);
      } catch(e) {
        fieldProdCache[id] = null;
      }
    }));
    if (i + BATCH < toFetch.length) await new Promise(r => setTimeout(r, 50));
  }
}

async function loadLicForFields(ids) {
  // Skip trial production fields — ownership handled by TRIAL_PROD_OWNERSHIP
  const toLoad = ids.filter(id => !licLoadedFor.has(id) && !TRIAL_PROD_OWNERSHIP[id]);
  // Mark trial prod fields as "loaded" so getShare uses the override
  ids.filter(id => TRIAL_PROD_OWNERSHIP[id]).forEach(id => {
    if (!fieldLicCache[id]) fieldLicCache[id] = [];
    licLoadedFor.add(id);
  });
  await Promise.all(toLoad.map(async id => {
    try {
      fieldLicCache[id] = [];
      let offset = 0;
      while (true) {
        const rows = await queryLayer(LIC_LAYER, {
          where:`fldNpdidField=${id}`,
          outFields:'cmpLongName,fldCompanyShare,fldLicenseeFrom,fldLicenseeTo',
          resultRecordCount:2000, resultOffset:offset
        });
        fieldLicCache[id] = fieldLicCache[id].concat(rows.map(r=>r.attributes));
        if (rows.length < 2000) break;
        offset += 2000;
      }
    } catch(e) { fieldLicCache[id] = []; }
    licLoadedFor.add(id);
  }));
}

let allLicPromise = null;
async function loadAllLicensees() {
  if (allLicLoaded) return;
  if (allLicPromise) return allLicPromise;
  allLicLoading = true;
  allLicPromise = (async () => {
  document.getElementById('cmpLoadingNotice').classList.add('visible');
  try {
    allLicRecords = [];
    let offset = 0;
    while (true) {
      const rows = await queryLayer(LIC_LAYER, {
        where:'1=1',
        outFields:'fldNpdidField,cmpLongName,fldCompanyShare,fldLicenseeFrom,fldLicenseeTo',
        resultRecordCount:2000, resultOffset:offset
      });
      rows.forEach(r => {
        const a = r.attributes;
        allLicRecords.push(a);
        if (!fieldLicCache[a.fldNpdidField]) fieldLicCache[a.fldNpdidField] = [];
        if (!licLoadedFor.has(a.fldNpdidField)) fieldLicCache[a.fldNpdidField].push(a);
      });
      if (rows.length < 2000) break;
      offset += 2000;
    }
    allLicRecords.forEach(r => licLoadedFor.add(r.fldNpdidField));
    const s = new Set(allLicRecords.map(r=>r.cmpLongName).filter(Boolean));
    allCompanies = sortCompanies([...s]);
    filteredCompanies = allCompanies;
    allLicLoaded = true;
  } finally {
    allLicLoading = false;
    document.getElementById('cmpLoadingNotice').classList.remove('visible');
  }
  })();
  return allLicPromise;
}

// ── RESERVES (for company sorting) ───────────────────────────────────────────
async function loadReserves() {
  if (reservesLoaded) return;
  try {
    let offset = 0;
    const totals = {};
    while (true) {
      const rows = await queryLayer(RES_LAYER, {
        where: '1=1',
        outFields: 'cmpLongName,cmpRecoverableOE',
        resultRecordCount: 2000,
        resultOffset: offset
      });
      rows.forEach(r => {
        const a = r.attributes;
        if (!a.cmpLongName) return;
        totals[a.cmpLongName] = (totals[a.cmpLongName] || 0) + (a.cmpRecoverableOE || 0);
      });
      if (rows.length < 2000) break;
      offset += 2000;
    }
    companyReserves = totals;
    reservesLoaded = true;
  } catch(e) {
    reservesLoaded = true;
  }
}

function sortCompanies(names) {
  return [...names].sort((a, b) => {
    if (a === 'Aker BP ASA') return -1;
    if (b === 'Aker BP ASA') return  1;
    const ra = companyReserves[a] || 0;
    const rb = companyReserves[b] || 0;
    if (ra !== rb) return rb - ra; // descending reserves
    return a.localeCompare(b, 'en');
  });
}

// ── VIEW TABS ────────────────────────────────────────────────────────────────
const FIELD_TABS   = [
  {id:'oilgas',        label:'Oil & Gas'},
  {id:'oe_per_field',  label:'OE per field'},
  {id:'oe_per_company',label:'OE per company'},
];
const COMPANY_TABS = [
  {id:'oilgas',       label:'Oil & Gas'},
  {id:'oe_per_field', label:'OE per field'},
];

function renderViewTabs() {
  const tabs = topMode === 'fields' ? FIELD_TABS : COMPANY_TABS;
  const cur  = topMode === 'fields' ? fieldSubView : companySubView;
  document.getElementById('viewTabs').innerHTML = tabs.map(t =>
    `<button class="view-tab${cur===t.id?' active':''}" onclick="setSubView('${t.id}')">${t.label}</button>`
  ).join('');
  // Water toggle: only in fields mode + oilgas view
  const showWaterRow = topMode === 'fields' && cur === 'oilgas';
  document.getElementById('waterRow').style.display = showWaterRow ? '' : 'none';
}

function setSubView(v) {
  if (topMode === 'fields') fieldSubView = v;
  else companySubView = v;
  renderViewTabs();
  refresh();
}

function setWater(val) { showWater = val; drawChart(); }
function setPeriod(p) {
  if (period === p) return;
  period = p;
  document.getElementById('btnMonthly').classList.toggle('active', p === 'monthly');
  document.getElementById('btnAnnual').classList.toggle('active',  p === 'annual');
  refresh();
}

// ── MODE SWITCH ───────────────────────────────────────────────────────────────
function switchMode(m) {
  if (topMode === m) return;
  topMode = m;
  document.getElementById('modeBtnFields').classList.toggle('active', m === 'fields');
  document.getElementById('modeBtnCompanies').classList.toggle('active', m === 'companies');
  renderViewTabs();
  updateFab();
  refresh();
}

// ── FAB + SHEET ───────────────────────────────────────────────────────────────
function updateFab() {
  const count = topMode === 'fields' ? selectedFieldIds.size : selectedCompanyNames.size;
  document.getElementById('fabBadge').textContent = count;
  const noun = topMode === 'fields' ? 'field' : 'company';
  const nounP = topMode === 'fields' ? 'fields' : 'companies';
  document.getElementById('fabLabel').textContent =
    count ? `${count} ${count>1?nounP:noun} selected` : `Select ${nounP}`;
  document.getElementById('sheetTitle').textContent =
    `Select ${topMode === 'fields' ? 'fields' : 'companies'}`;
}

function toggleSheet() { sheetOpen ? closeSheet() : openSheet(); }
function openSheet() {
  sheetOpen = true;
  document.getElementById('bottomSheet').classList.add('open');
  document.getElementById('sheetOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
  renderList();
}
function closeSheet() {
  sheetOpen = false;
  document.getElementById('bottomSheet').classList.remove('open');
  document.getElementById('sheetOverlay').classList.remove('open');
  document.body.style.overflow = '';
}

// ── LIST ─────────────────────────────────────────────────────────────────────
function renderList() {
  if (topMode === 'fields') renderFieldList();
  else renderCompanyList();
}

function renderFieldList() {
  const el = document.getElementById('checkList');
  if (!filteredFields.length) { el.innerHTML = '<div class="list-empty">No results</div>'; return; }
  el.innerHTML = '';
  filteredFields.forEach(f => {
    const item = document.createElement('div');
    item.className = 'check-item' + (selectedFieldIds.has(f.id) ? ' checked' : '');
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = selectedFieldIds.has(f.id);
    cb.addEventListener('change', () => toggleField(f.id, item, cb));
    item.appendChild(cb);
    item.appendChild(document.createTextNode(f.name));
    item.addEventListener('click', e => { if (e.target !== cb) cb.click(); });
    el.appendChild(item);
  });
}

function renderCompanyList() {
  const el = document.getElementById('checkList');
  if (!filteredCompanies.length) {
    el.innerHTML = allLicLoading
      ? '<div class="list-loading">Loading…</div>'
      : '<div class="list-empty">No results</div>';
    return;
  }
  el.innerHTML = '';
  filteredCompanies.forEach(name => {
    const item = document.createElement('div');
    item.className = 'check-item' + (selectedCompanyNames.has(name) ? ' checked' : '');
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = selectedCompanyNames.has(name);
    cb.addEventListener('change', () => toggleCompany(name, item, cb));
    item.appendChild(cb);
    item.appendChild(document.createTextNode(name));
    item.addEventListener('click', e => { if (e.target !== cb) cb.click(); });
    el.appendChild(item);
  });
}

function toggleField(id, item, cb) {
  if (selectedFieldIds.has(id)) { selectedFieldIds.delete(id); delete fieldProdCache[id]; }
  else selectedFieldIds.add(id);
  cb.checked = selectedFieldIds.has(id);
  item.classList.toggle('checked', selectedFieldIds.has(id));
  updateFab();
  refresh();
}

function toggleCompany(name, item, cb) {
  if (selectedCompanyNames.has(name)) selectedCompanyNames.delete(name);
  else selectedCompanyNames.add(name);
  cb.checked = selectedCompanyNames.has(name);
  item.classList.toggle('checked', selectedCompanyNames.has(name));
  updateFab();
  refresh();
}

function filterList() {
  const q = document.getElementById('listSearch').value.toLowerCase();
  if (topMode === 'fields') {
    filteredFields = allFields.filter(f=>f.name.toLowerCase().includes(q));
    renderFieldList();
  } else {
    // Filter but preserve sorted order
    filteredCompanies = allCompanies.filter(n=>n.toLowerCase().includes(q));
    renderCompanyList();
  }
}

function selectAll() {
  if (topMode === 'fields') { filteredFields.forEach(f=>selectedFieldIds.add(f.id)); renderFieldList(); }
  else { filteredCompanies.forEach(n=>selectedCompanyNames.add(n)); renderCompanyList(); }
  updateFab(); refresh();
}
function clearAll() {
  if (topMode === 'fields') { selectedFieldIds.clear(); fieldProdCache = {}; renderFieldList(); }
  else { selectedCompanyNames.clear(); renderCompanyList(); }
  updateFab(); refresh();
}

// ── MAIN REFRESH ─────────────────────────────────────────────────────────────
async function refresh() {
  if (topMode === 'fields') await refreshFields();
  else await refreshCompanies();
}

async function refreshFields() {
  const ids = [...selectedFieldIds];
  if (!ids.length) {
    setChartTitle('',''); setChartEmpty('Tap the button below to select one or more fields.');
    setInfo(''); return;
  }
  showSpinner();
  await loadProdForFields(ids);
  if (fieldSubView === 'oe_per_company') await loadLicForFields(ids);
  drawChart();
}

async function refreshCompanies() {
  const companies = [...selectedCompanyNames];
  if (!companies.length) {
    setChartTitle('',''); setChartEmpty('Tap the button below to select one or more companies.');
    setInfo(''); return;
  }
  if (!allLicLoaded) {
    showSpinner();
    await loadAllLicensees();
    filteredCompanies = allCompanies;
    if (sheetOpen) renderCompanyList();
  }
  // Find all fields for selected companies (from licensee records)
  const relevantIds = [...new Set(
    allLicRecords.filter(r=>selectedCompanyNames.has(r.cmpLongName)).map(r=>r.fldNpdidField)
  )];
  // Also include hardcoded trial production fields for selected companies
  Object.entries(TRIAL_PROD_OWNERSHIP).forEach(([id, owners]) => {
    Object.keys(owners).forEach(cmp => {
      if (selectedCompanyNames.has(cmp) && owners[cmp] > 0 && !relevantIds.includes(+id)) {
        relevantIds.push(+id);
      }
    });
  });
  // Clear failed/null cache entries so they get retried
  relevantIds.forEach(id => { if (fieldProdCache[id] === null) delete fieldProdCache[id]; });
  showSpinner();
  await loadProdForFields(relevantIds);
  drawChart();
}

// ── CHART DRAWING ─────────────────────────────────────────────────────────────
function showSpinner() {
  document.getElementById('chartArea').innerHTML =
    '<div class="status"><div class="spinner"></div><div>Loading…</div></div>';
  document.getElementById('downloadBtn').disabled = true;
}
function setChartEmpty(msg) {
  if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
  document.getElementById('chartArea').innerHTML = `<div class="status">${msg}</div>`;
  document.getElementById('downloadBtn').disabled = true;
}

function drawChart() {
  if (topMode === 'fields') {
    const sv = fieldSubView;
    if (sv === 'oilgas')         drawFieldsOilGas();
    else if (sv === 'oe_per_field')   drawFieldsOePerField();
    else if (sv === 'oe_per_company') drawFieldsOePerCompany();
  } else {
    const sv = companySubView;
    if (sv === 'oilgas')        drawCompaniesOilGas();
    else if (sv === 'oe_per_field') drawCompaniesOePerField();
  }
}

// ── FIELDS: OIL & GAS ────────────────────────────────────────────────────────
function drawFieldsOilGas() {
  const ids = [...selectedFieldIds];
  const labels = unionLabels(ids);
  if (!labels.length) { setChartEmpty('No data for selected period.'); return; }

  // If single field: oil, gas, (water) as separate series
  // If multiple fields: oil and gas stacked per field
  const datasets = [], legend = [];
  lastDatasets = [];

  if (ids.length === 1) {
    const id = ids[0];
    const fname = allFields.find(f=>f.id===id)?.name || '';
    const oilD = [], gasD = [], watD = [];
    labels.forEach(lbl => {
      const row = (fieldProdCache[id]||[]).find(r=>periodKey(r.attributes)===lbl);
      const a = row?.attributes || {};
      const d = a.prfYear ? days(a) : 30;
      oilD.push(+oilBoed(a.prfPrdOilNetMillSm3||0, a.prfPrdGasNetBillSm3||0, a.prfPrdOeNetMillSm3||0, d).toFixed(1));
      gasD.push(+gasBoed(a.prfPrdGasNetBillSm3||0, d).toFixed(1));
      watD.push(+waterBoed(a.prfPrdProducedWaterInFieldMillS||0, d).toFixed(1));
    });
    datasets.push({label:'Oil',   data:oilD, backgroundColor:OIL_COLOR,   borderWidth:0, stack:'s'});
    datasets.push({label:'Gas',   data:gasD, backgroundColor:GAS_COLOR,   borderWidth:0, stack:'s'});
    if (showWater) datasets.push({label:'Water', data:watD, backgroundColor:WATER_COLOR, borderWidth:0, stack:'s'});
    legend.push({label:'Oil',color:OIL_COLOR},{label:'Gas',color:GAS_COLOR});
    if (showWater) legend.push({label:'Water',color:WATER_COLOR});
    lastDatasets = [{label:'Oil',data:oilD},{label:'Gas',data:gasD}];
    if (showWater) lastDatasets.push({label:'Water',data:watD});
    setChartTitle(fname, `Oil${showWater?', Gas & Water production':' & Gas production'} · boe/day`);
    setInfo(`<strong>Field:</strong> ${fname} &nbsp;|&nbsp; <strong>Series:</strong> Oil, Gas${showWater?', Water':''} &nbsp;|&nbsp; <strong>Unit:</strong> boe/day &nbsp;|&nbsp; <strong>Basis:</strong> Gross field production`);
  } else {
    // Multiple fields: sum oil and gas across all fields per period
    const oilD = labels.map(lbl => {
      let tot = 0;
      ids.forEach(id => {
        const row = (fieldProdCache[id]||[]).find(r=>periodKey(r.attributes)===lbl);
        const a = row?.attributes||{}; const d = a.prfYear?days(a):30;
        tot += oilBoed(a.prfPrdOilNetMillSm3||0,a.prfPrdGasNetBillSm3||0,a.prfPrdOeNetMillSm3||0,d);
      });
      return +tot.toFixed(0);
    });
    const gasD = labels.map(lbl => {
      let tot = 0;
      ids.forEach(id => {
        const row = (fieldProdCache[id]||[]).find(r=>periodKey(r.attributes)===lbl);
        const a = row?.attributes||{}; const d = a.prfYear?days(a):30;
        tot += gasBoed(a.prfPrdGasNetBillSm3||0,d);
      });
      return +tot.toFixed(0);
    });
    const watD = showWater ? labels.map(lbl => {
      let tot = 0;
      ids.forEach(id => {
        const row = (fieldProdCache[id]||[]).find(r=>periodKey(r.attributes)===lbl);
        const a = row?.attributes||{}; const d = a.prfYear?days(a):30;
        tot += waterBoed(a.prfPrdProducedWaterInFieldMillS||0,d);
      });
      return +tot.toFixed(0);
    }) : [];
    datasets.push({label:'Oil',data:oilD,backgroundColor:OIL_COLOR,borderWidth:0,stack:'s'});
    datasets.push({label:'Gas',data:gasD,backgroundColor:GAS_COLOR,borderWidth:0,stack:'s'});
    if (showWater) datasets.push({label:'Water',data:watD,backgroundColor:WATER_COLOR,borderWidth:0,stack:'s'});
    legend.push({label:'Oil',color:OIL_COLOR},{label:'Gas',color:GAS_COLOR});
    if (showWater) legend.push({label:'Water',color:WATER_COLOR});
    lastDatasets = [{label:'Oil',data:oilD},{label:'Gas',data:gasD}];
    if (showWater) lastDatasets.push({label:'Water',data:watD});
    const fnames = ids.map(id=>allFields.find(f=>f.id===id)?.name).filter(Boolean).join(', ');
    setChartTitle(`${ids.length} fields · Oil & Gas production`, `${fnames} · boe/day`);
    setInfo(`<strong>Fields:</strong> ${fnames} &nbsp;|&nbsp; <strong>Series:</strong> Oil, Gas (summed) &nbsp;|&nbsp; <strong>Unit:</strong> boe/day &nbsp;|&nbsp; <strong>Basis:</strong> Gross field production`);
  }

  renderChart(labels, datasets, legend, 'boe/day');
}

// ── FIELDS: OE PER FIELD ─────────────────────────────────────────────────────
function drawFieldsOePerField() {
  const ids = [...selectedFieldIds];
  const labels = unionLabels(ids);
  if (!labels.length) { setChartEmpty('No data for selected period.'); return; }
  const datasets = [], legend = [];
  lastDatasets = [];
  ids.forEach((id, i) => {
    const fname = allFields.find(f=>f.id===id)?.name || id;
    const color = PALETTE[i % PALETTE.length][0];
    const d = labels.map(lbl => {
      const row = (fieldProdCache[id]||[]).find(r=>periodKey(r.attributes)===lbl);
      const a = row?.attributes||{}; const dy = a.prfYear?days(a):30;
      return +oeBoed(a.prfPrdOeNetMillSm3||0, dy).toFixed(0);
    });
    if (!hasAnyValue(d)) return;
    datasets.push({label:fname,data:d,backgroundColor:color,borderWidth:0,stack:'s'});
    legend.push({label:fname,color});
    lastDatasets.push({label:fname,data:d});
  });
  const fnames = ids.map(id=>allFields.find(f=>f.id===id)?.name).filter(Boolean).join(', ');
  setChartTitle(`Net production · OE per field`, `${fnames} · boe/day`);
  setInfo(`<strong>Fields:</strong> ${fnames} &nbsp;|&nbsp; <strong>Series:</strong> Net OE per field &nbsp;|&nbsp; <strong>Unit:</strong> boe/day &nbsp;|&nbsp; <strong>Basis:</strong> Gross field production`);
  renderChart(labels, datasets, legend, 'boe/day');
}

// ── FIELDS: OE PER COMPANY ────────────────────────────────────────────────────
function drawFieldsOePerCompany() {
  const ids = [...selectedFieldIds];
  const labels = unionLabels(ids);
  if (!labels.length) { setChartEmpty('No data for selected period.'); return; }

  // Collect all companies with share in any selected field
  const cmpSet = new Set();
  ids.forEach(id => (fieldLicCache[id]||[]).forEach(r => { if(r.cmpLongName) cmpSet.add(r.cmpLongName); }));
  const companies = [...cmpSet].sort();

  const datasets = [], legend = [];
  lastDatasets = [];

  companies.forEach((cmp, i) => {
    const color = PALETTE[i % PALETTE.length][0];
    const d = labels.map(lbl => {
      let total = 0;
      ids.forEach(id => {
        const row = (fieldProdCache[id]||[]).find(r=>periodKey(r.attributes)===lbl);
        const a = row?.attributes||{}; if (!a.prfYear) return;
        const dy = days(a);
        const share = getShare(id, midDate(a.prfYear,a.prfMonth||7), cmp) / 100;
        total += oeBoed(a.prfPrdOeNetMillSm3||0, dy) * share;
      });
      return +total.toFixed(0);
    });
    if (!hasAnyValue(d)) return;
    datasets.push({label:cmp,data:d,backgroundColor:color,borderWidth:0,stack:'s'});
    legend.push({label:cmp,color});
    lastDatasets.push({label:cmp,data:d});
  });

  const fnames = ids.map(id=>allFields.find(f=>f.id===id)?.name).filter(Boolean).join(', ');
  setChartTitle(`${fnames} · OE per company`, `Equity-adjusted · boe/day`);
  setInfo(`<strong>Fields:</strong> ${fnames} &nbsp;|&nbsp; <strong>Series:</strong> Net OE per company &nbsp;|&nbsp; <strong>Unit:</strong> boe/day &nbsp;|&nbsp; <strong>Basis:</strong> Equity-adjusted production`);
  renderChart(labels, datasets, legend, 'boe/day');
}

// ── COMPANIES: OIL & GAS ──────────────────────────────────────────────────────
function drawCompaniesOilGas() {
  const companies = [...selectedCompanyNames];
  const relevantIds = [...new Set([
    ...allLicRecords.filter(r=>selectedCompanyNames.has(r.cmpLongName)).map(r=>r.fldNpdidField),
    ...Object.entries(TRIAL_PROD_OWNERSHIP)
      .filter(([,owners]) => [...selectedCompanyNames].some(c=>(owners[c]||0)>0))
      .map(([id])=>+id)
  ])];
  const labels = unionLabels(relevantIds);
  if (!labels.length) { setChartEmpty('No data for selected period.'); return; }

  const datasets = [], legend = [];
  lastDatasets = [];

  if (companies.length === 1) {
    const cmp = companies[0];
    const cmpFields = getFieldsForCompany(cmp);
    const oilD = labels.map(lbl => {
      let tot = 0;
      cmpFields.forEach(id => {
        const row = (fieldProdCache[id]||[]).find(r=>periodKey(r.attributes)===lbl);
        const a = row?.attributes||{}; if (!a.prfYear) return;
        const dy = days(a), share = getShare(id, midDate(a.prfYear,a.prfMonth||7), cmp)/100;
        tot += oilBoed(a.prfPrdOilNetMillSm3||0,a.prfPrdGasNetBillSm3||0,a.prfPrdOeNetMillSm3||0,dy)*share;
      });
      return +tot.toFixed(0);
    });
    const gasD = labels.map(lbl => {
      let tot = 0;
      cmpFields.forEach(id => {
        const row = (fieldProdCache[id]||[]).find(r=>periodKey(r.attributes)===lbl);
        const a = row?.attributes||{}; if (!a.prfYear) return;
        const dy = days(a), share = getShare(id, midDate(a.prfYear,a.prfMonth||7), cmp)/100;
        tot += gasBoed(a.prfPrdGasNetBillSm3||0,dy)*share;
      });
      return +tot.toFixed(0);
    });
    datasets.push({label:'Oil',data:oilD,backgroundColor:OIL_COLOR,borderWidth:0,stack:'s'});
    datasets.push({label:'Gas',data:gasD,backgroundColor:GAS_COLOR,borderWidth:0,stack:'s'});
    legend.push({label:'Oil',color:OIL_COLOR},{label:'Gas',color:GAS_COLOR});
    lastDatasets = [{label:'Oil',data:oilD},{label:'Gas',data:gasD}];
    setChartTitle(`${cmp}`, `Oil & Gas production · equity-adjusted · boe/day`);
    setInfo(`<strong>Company:</strong> ${cmp} &nbsp;|&nbsp; <strong>Series:</strong> Oil, Gas &nbsp;|&nbsp; <strong>Unit:</strong> boe/day &nbsp;|&nbsp; <strong>Basis:</strong> Equity-adjusted, all fields`);
  } else {
    // Multiple companies: one OE series per company
    companies.forEach((cmp, i) => {
      const cmpFields = getFieldsForCompany(cmp);
      const color = PALETTE[i%PALETTE.length][0];
      const d = labels.map(lbl => {
        let tot = 0;
        cmpFields.forEach(id => {
          const row = (fieldProdCache[id]||[]).find(r=>periodKey(r.attributes)===lbl);
          const a = row?.attributes||{}; if (!a.prfYear) return;
          const dy = days(a), share = getShare(id, midDate(a.prfYear,a.prfMonth||7), cmp)/100;
          tot += oeBoed(a.prfPrdOeNetMillSm3||0,dy)*share;
        });
        return +tot.toFixed(0);
      });
      if (!hasAnyValue(d)) return;
      datasets.push({label:cmp,data:d,backgroundColor:color,borderWidth:0,stack:'s'});
      legend.push({label:cmp,color});
      lastDatasets.push({label:cmp,data:d});
    });
    setChartTitle(`${companies.length} companies · Net OE production`, `Equity-adjusted · boe/day`);
    setInfo(`<strong>Companies:</strong> ${companies.join(', ')} &nbsp;|&nbsp; <strong>Series:</strong> Net OE per company &nbsp;|&nbsp; <strong>Unit:</strong> boe/day &nbsp;|&nbsp; <strong>Basis:</strong> Equity-adjusted, all fields`);
  }
  renderChart(labels, datasets, legend, 'boe/day');
}

// ── COMPANIES: OE PER FIELD ───────────────────────────────────────────────────
function drawCompaniesOePerField() {
  const companies = [...selectedCompanyNames];
  const relevantIds = [...new Set([
    ...allLicRecords.filter(r=>selectedCompanyNames.has(r.cmpLongName)).map(r=>r.fldNpdidField),
    ...Object.entries(TRIAL_PROD_OWNERSHIP)
      .filter(([,owners]) => companies.some(c=>(owners[c]||0)>0))
      .map(([id])=>+id)
  ])];
  const labels = unionLabels(relevantIds);
  if (!labels.length) { setChartEmpty('No data for selected period.'); return; }

  const datasets = [], legend = [];
  lastDatasets = [];

  relevantIds.forEach((id, i) => {
    const fname = allFields.find(f=>f.id===id)?.name || `Field ${id}`;
    const color = PALETTE[i%PALETTE.length][0];
    const d = labels.map(lbl => {
      let tot = 0;
      companies.forEach(cmp => {
        const row = (fieldProdCache[id]||[]).find(r=>periodKey(r.attributes)===lbl);
        const a = row?.attributes||{}; if (!a.prfYear) return;
        const dy = days(a), share = getShare(id, midDate(a.prfYear,a.prfMonth||7), cmp)/100;
        tot += oeBoed(a.prfPrdOeNetMillSm3||0,dy)*share;
      });
      return +tot.toFixed(0);
    });
    if (!hasAnyValue(d)) return;
    datasets.push({label:fname,data:d,backgroundColor:color,borderWidth:0,stack:'s'});
    legend.push({label:fname,color});
    lastDatasets.push({label:fname,data:d});
  });

  const cmpStr = companies.join(', ');
  setChartTitle(`${companies.length === 1 ? companies[0] : companies.length + ' companies'} · OE per field`, `Equity-adjusted · boe/day`);
  setInfo(`<strong>Companies:</strong> ${cmpStr} &nbsp;|&nbsp; <strong>Series:</strong> Net OE per field &nbsp;|&nbsp; <strong>Unit:</strong> boe/day &nbsp;|&nbsp; <strong>Basis:</strong> Equity-adjusted production`);
  renderChart(labels, datasets, legend, 'boe/day');
}

// ── RENDER CHART ─────────────────────────────────────────────────────────────
function renderChart(labels, datasets, legend, yTitle) {
  lastLabels = labels;
  document.getElementById('chartArea').innerHTML = `
    <div class="chart-container"><canvas id="prodChart"></canvas></div>
    <div class="legend-row">${legend.map(l=>`
      <div class="legend-item">
        <div class="legend-dot" style="background:${l.color}"></div>${l.label}
      </div>`).join('')}
    </div>`;
  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(document.getElementById('prodChart').getContext('2d'), {
    type:'bar', data:{labels,datasets},
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{display:false},
        tooltip:{callbacks:{
          label: ctx => ` ${ctx.dataset.label}: ${Math.round(ctx.parsed.y).toLocaleString('en')} ${yTitle}`,
          footer: items => {
            const tot = items.reduce((s,i)=>s+i.parsed.y,0);
            return `Total: ${Math.round(tot).toLocaleString('en')} ${yTitle}`;
          }
        }}
      },
      scales:{
        x:{stacked:true,ticks:{maxTicksLimit:period==='annual'?15:10,maxRotation:45,font:{size:9}},grid:{color:'rgba(0,0,0,0.04)'}},
        y:{stacked:true,beginAtZero:true,title:{display:true,text:yTitle,color:'#4a5568',font:{size:10}},ticks:{font:{size:9}},grid:{color:'rgba(0,0,0,0.05)'}}
      }
    }
  });
  document.getElementById('downloadBtn').disabled = false;
}

// ── CHART TITLE ──────────────────────────────────────────────────────────────
function setChartTitle(main, sub) {
  const el = document.getElementById('chartTitle');
  el.innerHTML = main ? `${main}${sub ? `<span class="ct-sub">${sub}</span>` : ''}` : '';
}

// ── INFO BOX ─────────────────────────────────────────────────────────────────
function setInfo(html) {
  const box = document.getElementById('infoBox');
  box.style.display = html ? '' : 'none';
  box.innerHTML = html;
}

// ── EXCEL ─────────────────────────────────────────────────────────────────────
async function downloadExcel() {
  if (!lastLabels.length || !lastDatasets.length) return;

  const fy = document.getElementById('yearFrom').value;
  const ty = document.getElementById('yearTo').value;
  const periodLabel = period==='monthly'?'Monthly':'Annual';
  const infoText = document.getElementById('infoBox').innerText || '';
  const filename = `NCS_Production_${periodLabel}_${fy}-${ty}.xlsx`;

  const wb = new ExcelJS.Workbook();
  wb.creator = 'NCS Production Tool';
  wb.created = new Date();

  // ── Sheet 1: Info ──
  const wsInfo = wb.addWorksheet('Info');
  wsInfo.columns = [{width:24},{width:80}];
  const titleRow = wsInfo.addRow(['NCS Production Export']);
  titleRow.getCell(1).font = {bold:true, size:14};
  wsInfo.addRow([]);
  wsInfo.addRow(['Generated', new Date().toLocaleString()]);
  wsInfo.addRow(['Period type', periodLabel]);
  wsInfo.addRow(['Year range', `${fy} – ${ty}`]);
  wsInfo.addRow([]);
  wsInfo.addRow(['Data description']).getCell(1).font = {bold:true};
  wsInfo.addRow([infoText]);
  wsInfo.addRow([]);
  wsInfo.addRow(['Source']).getCell(1).font = {bold:true};
  const srcRow = wsInfo.addRow(['Norwegian Offshore Directorate (Sodir) FactPages – https://factpages.sodir.no – License: NLOD 2.0']);
  srcRow.getCell(1).font = {color:{argb:'FF0071B8'}};

  // ── Sheet 2: Data ──
  const wsData = wb.addWorksheet('Data');
  const header = [period==='monthly'?'Period':'Year', ...lastDatasets.map(d=>d.label)];
  wsData.columns = header.map((h,i) => ({header:h, width:i===0?12:20}));
  wsData.getRow(1).font = {bold:true};
  wsData.getRow(1).fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FFE8EEF5'}};
  lastLabels.forEach((lbl,i) => {
    const row = wsData.addRow([lbl, ...lastDatasets.map(d => d.data[i] ?? 0)]);
    if (i % 2 === 1) row.eachCell(cell => {
      cell.fill = {type:'pattern',pattern:'solid',fgColor:{argb:'FFF7F9FC'}};
    });
  });

  // ── Download ──
  const buf = await wb.xlsx.writeBuffer();
  const blob = new Blob([buf], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

// ── STARTUP ───────────────────────────────────────────────────────────────────
async function init() {
  renderViewTabs();
  updateFab();
  setInfo('');

  await Promise.all([loadFields(), loadAllLicensees(), loadReserves()]);
  allCompanies = sortCompanies(allCompanies);
  filteredCompanies = allCompanies;
  // Re-sort fields now that Aker BP licensee data is available
  const akerBpFieldIds = new Set(
    allLicRecords.filter(r=>r.cmpLongName==='Aker BP ASA').map(r=>r.fldNpdidField)
  );
  // Also include trial production fields owned by Aker BP
  Object.entries(TRIAL_PROD_OWNERSHIP).forEach(([id, owners]) => {
    if (owners['Aker BP ASA'] > 0) akerBpFieldIds.add(+id);
  });
  allFields.sort((a,b) => {
    const aA = akerBpFieldIds.has(a.id), aB = akerBpFieldIds.has(b.id);
    if (aA !== aB) return aA ? -1 : 1;
    return a.name.localeCompare(b.name,'en');
  });
  filteredFields = allFields;
  selectedCompanyNames.add('Aker BP ASA');
  updateFab();
  refresh();

  // Background prefetch: load all fields in background after initial render
  // so subsequent field selections are instant
  setTimeout(() => prefetchAllFields(), 2000);
}

async function prefetchAllFields() {
  const fy = +document.getElementById('yearFrom').value;
  const ty = +document.getElementById('yearTo').value;
  const unfetched = allFields
    .map(f => f.id)
    .filter(id => fieldProdCache[id] === undefined && !sessionGet(`prod_${id}_${fy}_${ty}`));
  if (!unfetched.length) return;
  // Fetch quietly in background, 3 at a time, no spinner
  const BATCH = 3;
  for (let i = 0; i < unfetched.length; i += BATCH) {
    const batch = unfetched.slice(i, i + BATCH);
    await Promise.all(batch.map(async id => {
      if (fieldProdCache[id] !== undefined) return; // already loaded by user interaction
      try {
        const rows = await queryLayer(PROD_LAYER, {
          where: `prfNpdidInformationCarrier=${id} AND prfYear>=${fy} AND prfYear<=${ty}`,
          outFields: 'prfNpdidInformationCarrier,prfYear,prfMonth,prfPrdOilNetMillSm3,prfPrdGasNetBillSm3,prfPrdOeNetMillSm3,prfPrdProducedWaterInFieldMillS',
          resultRecordCount: 32000
        });
        fieldProdCache[id] = rows;
        sessionSet(`prod_${id}_${fy}_${ty}`, rows);
      } catch(e) { /* silent fail */ }
    }));
    await new Promise(r => setTimeout(r, 100));
  }
}

init();
</script>
</body>
</html>